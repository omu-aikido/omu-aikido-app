---
import { default as Layout } from "@/src/layouts/layout.astro"
import { userActivity } from "@/src/lib/query/activity"
import { translateGrade, timeForNextGrade } from "@/src/utils"
import { AddRecord } from "@/rr7/components/component/AddRecord"
import { style } from "@/src/styles/component"
import MonthlyActivittyForm from "@/rr7/components/component/MonthlyActivityForm"
import NextGrade from "@/rr7/components/component/NextGrade"

const user = await Astro.locals.currentUser()

if (!user) {
  return Astro.redirect("/sign-in")
}
const userProfile = Astro.locals.profile!

const activityFromPreviousGrade = await userActivity({
  userId: user.id,
  start: new Date(
    userProfile.getGradeAt ? userProfile.getGradeAt :new Date(userProfile.joinedAt, 3, 1),
  ),
  end: new Date(),
})
const grade = userProfile.grade
const nextGrade = timeForNextGrade(grade)
const needToNextGrade = Math.max(
  0,
  Math.floor(
    nextGrade -
      activityFromPreviousGrade.map((record) => record.period).reduce((a, b) => a + b, 0) / 1.5,
  ),
)
---

<Layout title="きろく">
  <h1 class={style.text.title()}>きろく</h1>

  <NextGrade grade={grade} needToNextGrade={needToNextGrade} nextGrade={nextGrade} />
  <hr />
  <h2>追加</h2>

  <AddRecord client:load />
  <hr class="my-6 border-slate-200 dark:border-slate-700" />

  <div class="space-y-4">
    <div class="flex flex-col items-baseline sm:flex-row sm:items-center sm:justify-between gap-2">
      <h2 class="text-xl font-semibold text-slate-900 dark:text-white">今月の稽古履歴</h2>
      <a href="/apps/record/list" class={style.text.link()}> 全ての稽古履歴 &gt;&gt; </a>
    </div>
    <MonthlyActivittyForm client:load />
  </div>
</Layout>
